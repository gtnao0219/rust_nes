<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NES</title>
  </head>
  <body>
    <canvas id="game" width="256px" height="240px"></canvas>
    <script type="module">
      import init, { WasmNES } from "/pkg/rust_nes.js";

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");

      window.render_canvas = function (data) {
        const imageData = new ImageData(
          new Uint8ClampedArray(data),
          256,
          240
        );
        ctx.putImageData(imageData, 0, 0);
      };

      function getKeyIndex(keyCode) {
        switch (keyCode) {
          case 88: // X => A
            return 0;
          case 90: // Z => B
            return 1;
          case 32: // Space => Select
            return 2;
          case 13: // Enter => Start
            return 3;
          case 38: // Up => Up
            return 4;
          case 40: // Down => Down
            return 5;
          case 37: // Left => Left
            return 6;
          case 39: // Right => Right
            return 7;
          default:
            return null
        }
      }

      async function main() {
        const response = await fetch("/nes/rustynes/nestest.nes");
        const arrayBuffer = await response.arrayBuffer();
        const romData = new Uint8Array(arrayBuffer);

        await init();
        const wasmNES = WasmNES.new(romData);
        document.addEventListener('keydown', event => {
          const keyIndex = getKeyIndex(event.keyCode);
          if (keyIndex == null) {
            return;
          }
          wasmNES.key_down(keyIndex);
        });
        document.addEventListener('keyup', event => {
          const keyIndex = getKeyIndex(event.keyCode);
          if (keyIndex == null) {
            return;
          }
          wasmNES.key_up(keyIndex);
        });
        function loop() {
          wasmNES.frame();
          requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);
      }
      main();
    </script>
  </body>
</html>
